<html>
	<head>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
		<script src="https://unpkg.com/papaparse/papaparse.min.js"></script>
		<script src="leaflet.polylineDecorator.js"></script>
		<style>
			html, body {
				height: 100%;
				margin: 0;
			}
			body {
				padding: 0;
				margin: 0;
			}
			#map {
				width: 100vw;
				height: 100vh;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<script>
			L.Control.TestInfo = L.Control.extend({
				onAdd: function(map) {
					var div = L.DomUtil.create('div');

					function update_text() {
						div.innerHTML = `${map.getCenter()} (${map.getZoom()})`;
					}

					map.on('zoomlevelschange', update_text);
					map.on('load', update_text);
					map.on('move', update_text);

					update_text();

					return div;
				},

				onRemove: function(map) {
					// Nothing to do here
				}
			});

			L.control.testInfo = function(opts) {
				return new L.Control.TestInfo(opts);
			}

			var map = L.map('map', {
				preferCanvas: true,
				minZoom: 11,
				maxZoom: 18
			}).setView([59.987325, 30.342377], 18);
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {}).addTo(map);
			L.control.testInfo({ position: 'bottomleft' }).addTo(map);
			Papa.parse('output.csv', {
				download: true,
				header: true,
				skipEmptyLines: true,
				complete: function(result) {
					let data = result.data;
					console.log(data);
					if (result.errors.length > 0) {
						console.error(result.errors);
						return;
					}
					data.forEach((edge) => {
						let start_lat = Number(edge.start_lat);
						let end_lat = Number(edge.end_lat);
						let start_lon = Number(edge.start_lon);
						let end_lon = Number(edge.end_lon);
						let left_shadow = Number(edge.left_shadow);
						let right_shadow = Number(edge.right_shadow);
						let distance = Number(edge.distance);
						let details = edge.details;
						let coordinates = [
							[start_lat, start_lon],
							[end_lat, end_lon]
						];
						let sum = (left_shadow + right_shadow) / 2;
						let g = Math.round(255 * sum);
						let r = 255 - g;
						let b = sum < 0.1 ? 0 : 255;
						let color = (left_shadow <= 1 && right_shadow <= 1) ? `rgb(${r}, ${g}, ${b})` : 'green';
						let polyline = L.polyline(coordinates, {
							color,
							weight: 2,
						}).addTo(map);
						let tooltipText = `leftShadow = ${left_shadow.toFixed(2)}<br/>rightShadow = ${right_shadow.toFixed(2)}<br/>distance = ${distance.toFixed(2)}`;
						polyline.bindTooltip(tooltipText);
						let decorator = L.polylineDecorator(coordinates, {
							patterns: [{
								offset: '50%',
								repeat: 0,
								symbol: L.Symbol.arrowHead({
									pixelSize: 8,
									polygon: false,
									pathOptions: {
										stroke: true,
										color,
										weight: 2
									}
								})
							}]
						}).addTo(map);
					})
				}
			})
		</script>
	</body>
</html>