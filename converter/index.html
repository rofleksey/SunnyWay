<html>
	<head>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="leaflet.polylineDecorator.js"></script>
		<style>
			html, body {
				height: 100%;
				margin: 0;
			}
			body {
				padding: 0;
				margin: 0;
			}
			#map {
				width: 100vw;
				height: 100vh;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<script>
			L.Control.TestInfo = L.Control.extend({
				onAdd: function(map) {
					var div = L.DomUtil.create('div');

					function update_text() {
						div.innerHTML = `${map.getCenter()} (${map.getZoom()})`;
					}

					map.on('zoomlevelschange', update_text);
					map.on('load', update_text);
					map.on('move', update_text);

					update_text();

					return div;
				},

				onRemove: function(map) {
					// Nothing to do here
				}
			});

			L.control.testInfo = function(opts) {
				return new L.Control.TestInfo(opts);
			}

			const map = L.map('map', {
				preferCanvas: true,
				minZoom: 11,
				maxZoom: 18
			}).setView([59.987325, 30.342377], 18);
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {}).addTo(map);
			L.control.testInfo({ position: 'bottomleft' }).addTo(map);

			let startMarker = null;
			let startLatLng = null;

			let endMarker = null;
			let endLatLng = null;

			let pending = false;
			let path = [];

			map.on('click', (e) => {
				if (pending) {
					return
				}
				const marker = L.marker(e.latlng).addTo(map);
				if (!startMarker) {
					startMarker = marker;
					startLatLng = e.latlng;
					console.log(e.latlng)
				} else {
					endMarker = marker
					endLatLng = e.latlng;
				}
				if (path) {
					path.forEach((polyline) => {
						polyline.remove();
					});
					path = [];
				}
				if (endMarker) {
					pending = true;
					axios.post("http://localhost:7000/api/nav", {
						from: {
							lat: startLatLng.lat,
							lon: startLatLng.lng
						},
						to: {
							lat: endLatLng.lat,
							lon: endLatLng.lng
						},
						algorithm: 'Distance'
					}).then((res) => {
						console.log(res.data)
						const color = 'green';
						for(let i = 1; i < res.data.path.length; i++) {
							const prev = res.data.path[i-1];
							const cur = res.data.path[i];
							const polyline = L.polyline([[prev.lat, prev.lon], [cur.lat, cur.lon]], {
								color,
								weight: 2,
							}).addTo(map);
							path.push(polyline);
						}
					}).catch((e) => {
						console.error(e)
					}).finally(() => {
						pending = false;
						startMarker.remove();
						endMarker.remove();
						startMarker = null;
						endMarker = null;
					})
				}
			})
		</script>
	</body>
</html>